#!/bin/zsh

# Scale images to my eReader (1072Ã—1448)

# Environment variable
# - BY (default is 50)
#     Process image by group of BY.
#     Greater value is faster, but use more memory.
# - LEFT_TO_RIGHT (default is 0)
#     Reverse the of double pages when splitted.

declare -i by

width=1072
height=1448
by=${BY:=50}
rename_idx=0

(( by )) || by=50
(( ${LEFT_TO_RIGHT:=0} )) || rename_idx=1

files=()
for f in $@ ; {
  [[ $f[1] == / ]] && p= || p=./
  [[ -d $f ]] && files+=($p$f/**/*(^/)) || files+=($p$f)
}

for ((i=1; i <= $#files; i+=$by)) {
  gmic $files[$i,$i+$by-1] \
  -adjust_colors'[0-100%]' -5,10 \
  dk=0 \
  -repeat '$!' \
    -if '{w#$dk>h#$dk}' \
      -split_tiles'[$dk]' 2,1 \
      -name'[{$dk+'$rename_idx'}]' '{$dk,f}/{$dk,b}_a.{$dk,x}' \
      dk+=1 \
    -fi \
    dk+=1 \
  -done \
  -autocrop'[0-100%]' \
  -repeat '$dk' \
    -if '{w#$>>'$width'||h#$>>'$height'}' \
      'ratio=max({w#$>/'$width'},{h#$>/'$height'})' \
      -resize_mn'[$>]' '{w#$>/$ratio},{h#$>/$ratio},1,1' \
    -fi \
    -o'[$>]' 'jpg:{$>,n},40' \
  -done -q
}
