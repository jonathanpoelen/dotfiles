#!/usr/bin/env zsh

set -e

SCK=~/rawdisk/music-control.sck
PIPE=~/rawdisk/music-control.pipe

rm $PIPE 2>/dev/null ||:
# to send commands before the server is launched
mkfifo $PIPE
{
  # wait until the server to open
  sleep 3
  # redirects a pipe file to the ipc server
  tail -f $PIPE | socat - $SCK
  # do not use `socat PIPE:$PIPE $SCK`,
  # because it causes infinite cpu usage when a track is not found (???)
}&

# --stream-buffer-size=2MiB reading by chunk of 256KiB... (?)
mpv --no-resume-playback --quiet --shuffle \
  --idle=yes --input-ipc-server=$SCK \
  --no-video --no-input-terminal \
  --stream-buffer-size=2MiB \
  --reset-on-next-file=loop-file --loop-playlist "$@"
